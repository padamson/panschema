name: Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  # Allow this workflow to be called by other workflows (e.g., release.yml)
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable]

    steps:
    - uses: actions/checkout@v6

    - name: Install Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ matrix.rust }}
        components: rustfmt, clippy

    - name: Cache Cargo
      uses: actions/cache@v5
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
          drivers/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-

    - name: Install cargo-nextest
      uses: taiki-e/install-action@nextest

    - name: Setup Node.js (for Playwright)
      uses: actions/setup-node@v6
      with:
        node-version: '20'

    - name: Get Playwright version
      id: playwright-version
      shell: bash
      run: echo "version=1.56.1" >> $GITHUB_OUTPUT

    - name: Cache Playwright browsers and driver
      uses: actions/cache@v5
      id: playwright-cache
      with:
        path: |
          ~/.cache/ms-playwright
          ~/.cache/playwright-rust
          ~/Library/Caches/ms-playwright
          ~/Library/Caches/playwright-rust
          ~/AppData/Local/ms-playwright
          ~/AppData/Local/playwright-rust
        key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}

    - name: Install Playwright browsers
      if: steps.playwright-cache.outputs.cache-hit != 'true'
      run: npx playwright@1.56.1 install --with-deps

    - name: Install Playwright dependencies (cached)
      if: steps.playwright-cache.outputs.cache-hit == 'true'
      shell: bash
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          npx playwright@1.56.1 install-deps
        fi

    - name: Check formatting
      run: cargo fmt -- --check

    - name: Clippy (release)
      run: cargo clippy --all-targets -- -D warnings

    - name: Clippy (with dev feature)
      run: cargo clippy --all-targets --features dev -- -D warnings

    - name: Run tests (release)
      run: cargo nextest run
      env:
        BROWSER: all

    - name: Run tests (with dev feature)
      run: cargo nextest run --features dev
      env:
        BROWSER: all
